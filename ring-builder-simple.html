<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Ring Builder Doc Example</title>
    <style>body{font-family:sans-serif;display:flex;height:100vh;margin:0}#viewer{flex:2}#controls{flex:1;padding:20px;overflow-y:auto}.group{margin-bottom:20px;border-bottom:1px solid #ccc;padding-bottom:10px}button{margin:5px;padding:8px;cursor:pointer}button.active{background:#000;color:#fff}</style>
</head>
<body>
    <div id="viewer"></div>
    <div id="controls"><h2>Controls</h2></div>
    <script src="https://releases.ijewel3d.com/libs/mini-viewer/0.5.10-dev.3/bundle.iife.js"></script>
    <script>
        const CONFIG = { fileId: 'M0BEKF9qSDiF_Mk3t0NGsA', instance: 'dev-2' };
        let viewer, builder, matPlugin;
        const ui = document.getElementById('controls');

        //initialize viewer and load model
        ijewelViewer.loadModelById(CONFIG.fileId, CONFIG.instance, document.getElementById('viewer'), {
            showConfigurator: false,
            showCard: false,
        });

        window.addEventListener('ijewel-viewer-ready', ({ detail }) => {
            viewer = detail.viewer;
            builder = viewer.getPluginByType('RingBuilder');
            matPlugin = viewer.getPluginByType('MaterialConfiguratorPlugin');
            
            if(builder) builder.addEventListener('componentProcessed', renderUI); // Re-render if components change
            if(matPlugin) matPlugin.addEventListener('refreshUi', renderUI); // Re-render if materials change
            
            renderUI();
        });

        function renderUI() {
            ui.innerHTML = '<h2>Controls</h2>';

            // 1. Render Ring Components (Shanks, Heads, etc.)
            if(builder?.components) {
                builder.components.forEach((component, cIdx) => {
                    if(!component.visible) return;
                    const div = document.createElement('div');
                    div.className = 'group';
                    div.innerHTML = `<h3>${component.name}</h3>`;
                    
                    component.variations.forEach((variation, vIdx) => {
                        const btn = document.createElement('button');
                        btn.textContent = variation.name || variation.title || `Var ${vIdx}`;
                        
                        if(vIdx === component.selectedIndex) btn.className = 'active'; 

                        btn.onclick = async () => {
                            btn.textContent = '...';
                            await component.applyVariation(variation); // this line is responsible for the actual change
                            renderUI(); 
                        };
                        div.appendChild(btn);
                    });
                    ui.appendChild(div);
                });
            }

            // 2. Render Materials
            if(matPlugin?.variations) {
                matPlugin.variations.forEach((grp) => {
                    if(!grp.materials) return; 

                    const div = document.createElement('div');
                    div.className = 'group';
                    div.innerHTML = `<h3>${grp.title}</h3>`;
                    
                    grp.materials.forEach((mat, mIdx) => {
                        const btn = document.createElement('button');
                        btn.textContent = mat.userData?.label || mat.name || mat.uuid;
                        
                        if(grp.selectedIndex === mIdx) btn.className = 'active';
                        
                        btn.onclick = async () => {
                            await matPlugin.applyVariation(grp, mat.uuid);
                            renderUI();
                        };
                        div.appendChild(btn);
                    });
                    ui.appendChild(div);
                });
            }
        }
    </script>
</body>
</html>